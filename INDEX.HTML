<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <title>勞工體格管理分析系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/fhirclient@2/build/fhir-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1, h2 { color: #2c3e50; }
    .container { max-width: 1200px; margin: auto; }
    .section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .upload-area {
      border: 2px dashed #3498db;
      padding: 40px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
    }
    .upload-area:hover { background: #ecf0f1; }
    button { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #2980b9; }
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
    canvas { background: #fff; border-radius: 8px; }
    #status { margin: 15px 0; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>勞工體格管理分析系統</h1>
    <p id="patient-info">載入中...</p>
    <div id="status"></div>

    <div class="section">
      <h2>1. 資料匯入</h2>
      
      <h3>選項 A：從 FHIR 伺服器讀取勞工體檢資料</h3>
      <button onclick="loadFromFHIR()">載入目前單位所有勞工體檢資料</button>

      <h3 style="margin-top: 30px;">選項 B：匯入外部 CSV 檔案（單人或批次）</h3>
      <div class="upload-area" onclick="document.getElementById('csvFile').click()">
        <p>點擊此處或拖曳 CSV 檔案至此匯入</p>
        <input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="handleCSVUpload(event)" multiple>
      </div>
      <p><small>支援格式：包含身高、體重、血壓、腰圍、血糖、血脂、GPT、肌酸酐等欄位</small></p>
    </div>

    <div class="section">
      <h2>2. 健康狀態統計分析</h2>
      <div class="charts">
        <div><canvas id="bmiChart"></canvas></div>
        <div><canvas id="bpChart"></canvas></div>
        <div><canvas id="bloodSugarChart"></canvas></div>
        <div><canvas id="metabolicChart"></canvas></div>
        <div><canvas id="lipidChart"></canvas></div>
      </div>
    </div>
  </div>

  <script>
    let patientData = [];
    let charts = {};

    // SMART on FHIR 初始化
    FHIR.oauth2.ready()
      .then(client => {
        document.getElementById("patient-info").textContent = "已連線至 FHIR 伺服器，準備載入資料";
        window.fhirClient = client;
      })
      .catch(err => {
        document.getElementById("status").textContent = "SMART 啟動失敗，請重新從 EHR 啟動應用程式";
        console.error(err);
      });

    // 從 FHIR 載入資料（示意，實際需批次查詢 Bundle 或 Group）
    async function loadFromFHIR() {
      if (!window.fhirClient) {
        alert("尚未完成 SMART 認證");
        return;
      }
      document.getElementById("status").textContent = "正在從 FHIR 伺服器讀取勞工體檢資料...";
      // 實際實作需根據單位定義 Group 或使用 Bundle 批次查詢 Observation
      // 此處為示意
      alert("已載入 93 筆勞工體檢資料（模擬）");
      document.getElementById("status").textContent = "FHIR 資料載入完成，共 93 筆";
      analyzeData(sampleDataFromBundle()); // 使用您提供的 JSON 資料模擬
    }

    // CSV 上傳處理
    function handleCSVUpload(event) {
      const files = event.target.files;
      if (files.length === 0) return;
      document.getElementById("status").textContent = `正在處理 ${files.length} 個 CSV 檔案...`;
      // 實際需用 PapaParse 或自訂解析 CSV
      alert("CSV 匯入功能開發中，未來將支援批次轉換為 FHIR 格式並分析");
    }

    // 模擬從您提供的 Bundle 解析資料
    function sampleDataFromBundle() {
      // 這裡可放入您提供的 JSON 解析邏輯
      // 為簡化，直接使用文件中部分資料作為範例
      return [
        { name: "林o恩", bmi: 35.7, sbp: 132, dbp: 81, glucose: 100, waist: 100, gender: "female" },
        { name: "陳o霖", bmi: 32.9, sbp: 150, dbp: 105, glucose: 105, waist: 61, gender: "male" },
        // ... 可繼續加入其他 91 筆
      ];
    }

    // 分析並繪圖
    function analyzeData(data) {
      patientData = data;
      createBMIChart();
      createBPChart();
      createBloodSugarChart();
      // 其他圖表：代謝症候群、血脂等可陸續加入
    }

    function createBMIChart() {
      const ctx = document.getElementById('bmiChart').getContext('2d');
      const counts = { under: 0, normal: 0, over: 0, obese1: 0, obese2: 0, obese3: 0 };
      patientData.forEach(p => {
        if (p.bmi < 18.5) counts.under++;
        else if (p.bmi < 24) counts.normal++;
        else if (p.bmi < 27) counts.over++;
        else if (p.bmi < 30) counts.obese1++;
        else if (p.bmi < 35) counts.obese2++;
        else counts.obese3++;
      });

      charts.bmi = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['體重過輕 (<18.5)', '正常 (18.5-24)', '過重 (24-27)', '輕度肥胖 (27-30)', '中度肥胖 (30-35)', '重度肥胖 (≥35)'],
          datasets: [{
            label: '人數',
            data: [counts.under, counts.normal, counts.over, counts.obese1, counts.obese2, counts.obese3],
            backgroundColor: '#3498db'
          }]
        },
        options: { responsive: true, plugins: { title: { display: true, text: 'BMI 分佈 (國健署標準)' } } }
      });
    }

    function createBPChart() {
      const ctx = document.getElementById('bpChart').getContext('2d');
      const levels = { normal: 0, elevated: 0, stage1: 0, stage2: 0, crisis: 0 };
      patientData.forEach(p => {
        if (p.sbp < 120 && p.dbp < 80) levels.normal++;
        else if (p.sbp < 130 && p.dbp < 80) levels.elevated++;
        else if (p.sbp < 140 || p.dbp < 90) levels.stage1++;
        else if (p.sbp >= 140 || p.dbp >= 90) levels.stage2++;
        if (p.sbp >= 180 || p.dbp >= 120) levels.crisis++;
      });

      charts.bp = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['正常', '血壓升高', '第一期高血壓', '第二期高血壓', '高血壓危機'],
          datasets: [{ data: [levels.normal, levels.elevated, levels.stage1, levels.stage2, levels.crisis], backgroundColor: ['#2ecc71', '#f1c40f', '#e67e22', '#e74c3c', '#c0392b'] }]
        },
        options: { responsive: true, plugins: { title: { display: true, text: '血壓分級 (國健署/ACC/AHA標準)' } } }
      });
    }

    function createBloodSugarChart() {
      const ctx = document.getElementById('bloodSugarChart').getContext('2d');
      const counts = { normal: 0, prediabetes: 0, diabetes: 0 };
      patientData.forEach(p => {
        if (p.glucose < 100) counts.normal++;
        else if (p.glucose < 126) counts.prediabetes++;
        else counts.diabetes++;
      });

      charts.glucose = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['正常 (<100 mg/dL)', '糖尿病前期 (100-125)', '糖尿病 (≥126)'],
          datasets: [{ data: [counts.normal, counts.prediabetes, counts.diabetes], backgroundColor: ['#2ecc71', '#f1c40f', '#e74c3c'] }]
        },
        options: { responsive: true, plugins: { title: { display: true, text: '空腹血糖分佈' } } }
      });
    }
  </script>
</body>
</html>